-- SERVICES
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")

-- CALLBACKS (for external customization)
local callbacks = {
    OnTogglePlayerList = function(open) end,
    OnPlayerSelected = function(playerName) end,
}

-- GUI CREATION
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MyInjectorUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

-- OUTER FRAME WITH GRADIENT BORDER
local OutlineFrame = Instance.new("Frame")
OutlineFrame.Size = UDim2.new(0.4, 4, 0, 44)
OutlineFrame.Position = UDim2.new(0.3, -2, 0, 0)
OutlineFrame.BackgroundTransparency = 1
OutlineFrame.BorderSizePixel = 0
OutlineFrame.Parent = ScreenGui

local GradientOutline = Instance.new("UIGradient")
GradientOutline.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 255)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 255))
}
GradientOutline.Rotation = 90
GradientOutline.Parent = OutlineFrame

-- TOP BAR (at the top)
local TopBar = Instance.new("Frame")
TopBar.Name = "TopBar"
TopBar.Size = UDim2.new(1, 0, 0, 50)
TopBar.BackgroundColor3 = Color3.fromRGB(34, 34, 34)
TopBar.BackgroundTransparency = 0.3
TopBar.BorderSizePixel = 0
TopBar.Parent = OutlineFrame

local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 8)
Corner.Parent = TopBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0, 150, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "My GUI"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.Font = Enum.Font.SourceSansBold
TitleLabel.TextSize = 20
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TopBar

-- THE toggle button ("ðŸ‘¤")
local PlayerListButton = Instance.new("TextButton")
PlayerListButton.Name = "PlayerListButton"
PlayerListButton.Size = UDim2.new(0, 40, 0, 40)
PlayerListButton.Position = UDim2.new(0.5, -20, 0.5, -20)
PlayerListButton.BackgroundColor3 = Color3.fromRGB(85, 170, 255)
PlayerListButton.Text = "ðŸ‘¤"
PlayerListButton.TextSize = 20
PlayerListButton.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayerListButton.Font = Enum.Font.SourceSans
PlayerListButton.Parent = TopBar

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 8)
toggleCorner.Parent = PlayerListButton

-- Close button ("X")
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.AnchorPoint = Vector2.new(1, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 20
CloseButton.Parent = TopBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = CloseButton

-- PLAYER LIST WINDOW
local PlayerListFrame = Instance.new("Frame")
PlayerListFrame.Size = UDim2.new(0, 200, 0, 300)
PlayerListFrame.Position = UDim2.new(0.5, -100, 0.5, -150)
PlayerListFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
PlayerListFrame.BorderSizePixel = 0
PlayerListFrame.Visible = false
PlayerListFrame.Parent = ScreenGui

local listCorner = Instance.new("UICorner")
listCorner.CornerRadius = UDim.new(0, 8)
listCorner.Parent = PlayerListFrame

local PlayerListTitle = Instance.new("TextLabel")
PlayerListTitle.Size = UDim2.new(1, 0, 0, 30)
PlayerListTitle.Position = UDim2.new(0, 0, 0, 0)
PlayerListTitle.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
PlayerListTitle.BackgroundTransparency = 0.7  -- Transparent
PlayerListTitle.Text = "Player List"
PlayerListTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayerListTitle.Font = Enum.Font.SourceSansBold
PlayerListTitle.TextSize = 18
PlayerListTitle.Parent = PlayerListFrame

-- Minimize button for Player List
local MinimizeListButton = Instance.new("TextButton")
MinimizeListButton.Size = UDim2.new(0, 20, 0, 20)
MinimizeListButton.Position = UDim2.new(1, -25, 0, 5)
MinimizeListButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
MinimizeListButton.BackgroundTransparency = 0.7
MinimizeListButton.Text = "-"
MinimizeListButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeListButton.Font = Enum.Font.SourceSansBold
MinimizeListButton.TextSize = 20
MinimizeListButton.Parent = PlayerListFrame

-- PLAYER OPTIONS WINDOW (attached to the right)
local PlayerOptionsFrame = Instance.new("Frame")
PlayerOptionsFrame.Size = UDim2.new(0, 200, 0, 100)
PlayerOptionsFrame.Position = UDim2.new(1, 0, 0, 0)
PlayerOptionsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
PlayerOptionsFrame.BorderSizePixel = 0
PlayerOptionsFrame.Visible = false
PlayerOptionsFrame.Parent = PlayerListFrame

local optionsCorner = Instance.new("UICorner")
optionsCorner.CornerRadius = UDim.new(0, 8)
optionsCorner.Parent = PlayerOptionsFrame

local PlayerOptionsTitle = Instance.new("TextLabel")
PlayerOptionsTitle.Size = UDim2.new(1, 0, 0, 30)
PlayerOptionsTitle.Position = UDim2.new(0, 0, 0, 0)
PlayerOptionsTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
PlayerOptionsTitle.BackgroundTransparency = 0.7 -- Transparent
PlayerOptionsTitle.Text = ""  -- Will update to player name on selection
PlayerOptionsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
PlayerOptionsTitle.Font = Enum.Font.SourceSansBold
PlayerOptionsTitle.TextSize = 16
PlayerOptionsTitle.Parent = PlayerOptionsFrame

-- Minimize button for Player Options
local MinimizeOptionsButton = Instance.new("TextButton")
MinimizeOptionsButton.Size = UDim2.new(0, 20, 0, 20)
MinimizeOptionsButton.Position = UDim2.new(1, -25, 0, 5)
MinimizeOptionsButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
MinimizeOptionsButton.BackgroundTransparency = 0.7
MinimizeOptionsButton.Text = "-"
MinimizeOptionsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeOptionsButton.Font = Enum.Font.SourceSansBold
MinimizeOptionsButton.TextSize = 20
MinimizeOptionsButton.Parent = PlayerOptionsFrame

-- "TP to player" button inside Player Options
local TpButton = Instance.new("TextButton")
TpButton.Size = UDim2.new(1, -10, 0, 30)
TpButton.Position = UDim2.new(0, 5, 0, 35)
TpButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
TpButton.BackgroundTransparency = 0.5 -- Transparent
TpButton.Text = "TP to player"
TpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TpButton.Font = Enum.Font.SourceSans
TpButton.TextSize = 14
TpButton.Parent = PlayerOptionsFrame

-- "Bring player" button below TP to player
local BringButton = Instance.new("TextButton")
BringButton.Size = UDim2.new(1, -10, 0, 30)
BringButton.Position = UDim2.new(0, 5, 0, 70)
BringButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
BringButton.BackgroundTransparency = 0.5 -- Transparent
BringButton.Text = "Bring player"
BringButton.TextColor3 = Color3.fromRGB(255, 255, 255)
BringButton.Font = Enum.Font.SourceSans
BringButton.TextSize = 14
BringButton.Parent = PlayerOptionsFrame

-- VARIABLES
local TpPlayerName = nil -- store selected player name

-- FUNCTION: Populate player list
local function refreshPlayerList()
    -- Remove previous entries
    for _, child in pairs(PlayerListFrame:GetChildren()) do
        if child:IsA("TextButton") and child ~= PlayerListTitle and child ~= MinimizeListButton then
            child:Destroy()
        end
    end

    -- Add current players
    for _, player in pairs(Players:GetPlayers()) do
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, -10, 0, 20)
        btn.BackgroundTransparency = 1
        btn.Text = player.Name
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.Font = Enum.Font.SourceSans
        btn.TextSize = 14
        btn.Parent = PlayerListFrame

        -- On click, select player
        btn.MouseButton1Click:Connect(function()
            callbacks.OnPlayerSelected(player.Name)
            TpPlayerName = player.Name
            PlayerOptionsTitle.Text = player.Name
            PlayerOptionsFrame.Visible = true
        end)
    end
end

-- INITIAL POPULATION
refreshPlayerList()

-- UPDATE on join/leave
Players.PlayerAdded:Connect(refreshPlayerList)
Players.PlayerRemoving:Connect(refreshPlayerList)

-- MAKE PlayerListFrame draggable
local function makeDraggable(frame, dragPart)
    local dragging = false
    local dragStart, startPos

    dragPart.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input, gameProcessed)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

makeDraggable(PlayerListFrame, PlayerListTitle)

-- Minimize button functionality for Player List
MinimizeListButton.MouseButton1Click:Connect(function()
    PlayerListFrame.Visible = false
    PlayerOptionsFrame.Visible = false
    callbacks.OnTogglePlayerList(false)
end)

-- Minimize button functionality for Player Options
MinimizeOptionsButton.MouseButton1Click:Connect(function()
    PlayerOptionsFrame.Visible = false
end)

-- BUTTON: Close GUI
CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- BUTTON: Toggle Player List
PlayerListButton.MouseButton1Click:Connect(function()
    local isVisible = not PlayerListFrame.Visible
    PlayerListFrame.Visible = isVisible
    if not isVisible then
        PlayerOptionsFrame.Visible = false
    end
    callbacks.OnTogglePlayerList(isVisible)
end)

-- BUTTON: TP to player
TpButton.MouseButton1Click:Connect(function()
    if TpPlayerName then
        local targetPlayer = Players:FindFirstChild(TpPlayerName)
        local localPlayer = Players.LocalPlayer
        if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
            if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local hrpLocal = localPlayer.Character.HumanoidRootPart
                local hrpTarget = targetPlayer.Character.HumanoidRootPart
                hrpLocal.CFrame = hrpTarget.CFrame + Vector3.new(0, 3, 0)
            end
        end
    end
end)

-- BUTTON: Bring player
BringButton.MouseButton1Click:Connect(function()
    if TpPlayerName then
        local playerToBring = Players:FindFirstChild(TpPlayerName)
        local localPlayer = Players.LocalPlayer
        if playerToBring and playerToBring.Character and playerToBring.Character:FindFirstChild("HumanoidRootPart") then
            if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local hrpLocal = localPlayer.Character.HumanoidRootPart
                local hrpTarget = playerToBring.Character.HumanoidRootPart
                hrpTarget.CFrame = hrpLocal.CFrame + Vector3.new(0, 3, 0)
            end
        end
    end
end)
